<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Vue响应原理 · Hexo</title><meta name="description" content="Vue响应原理 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/zoey.github.io/favicon.png"><link rel="stylesheet" href="/zoey.github.io/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Hexo"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/zoey.github.io/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/zoey.github.io/" class="logo-link"><img src="/zoey.github.io/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/zoey.github.io/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/zoey.github.io/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/zoey.github.io/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Vue响应原理</h1><div class="post-info">Jul 6, 2019</div><div class="post-content"><h3 id="Copy自"><a href="#Copy自" class="headerlink" title="Copy自"></a>Copy自</h3><p><a href="https://cn.vuejs.org/v2/guide/reactivity.html" target="_blank" rel="noopener">官方文档</a></p>
<h3 id="如何追踪变化"><a href="#如何追踪变化" class="headerlink" title="如何追踪变化"></a>如何追踪变化</h3><p>Vue会遍历data选项中的所有属性，并使用<code>Object.defineProperty</code>把这些属性全部转化为<code>getter/setter</code>。<br><code>Object.defineProperty</code>是ES5中一个<strong>无法优雅降级</strong>的特性，这也是Vue不支持IE8及更低版本浏览器的原因。</p>
<p>这些<code>getter/setter</code>对用户来说是不可见的，但是它们让Vue能够追踪依赖，在属性被访问和修改时通过<code>getter/setter</code>来通知变更。</p>
<p>每个组件实例都对应一个<strong>watcher</strong>实例，它会在组件渲染的过程中把“接触”过的数据属性记录为依赖。之后当依赖项的setter触发时，会通知watcher，从而使它关联的组件重新渲染。</p>
<h3 id="检测变化的注意事项"><a href="#检测变化的注意事项" class="headerlink" title="检测变化的注意事项"></a>检测变化的注意事项</h3><p>受现代JavaScript的限制，Vue<strong>无法检测到对象属性的添加或删除</strong>。<br>Vue会在<strong>初始化实例时</strong>对属性执行<code>getter/setter</code>转化，所以属性必须一开始就得在<code>data</code>对象上存在才能让Vue用<code>Object.defineProperty</code>将它转化为响应式的。列如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;span v-for&#x3D;&quot;(item, index) in obj&quot; :key&#x3D;&quot;index&quot;&gt;&#123;&#123;item&#125;&#125;&lt;&#x2F;span&gt;</span><br><span class="line">    &lt;button @click&#x3D;&quot;addObj&quot;&gt;添加属性&lt;&#x2F;button&gt; &#x2F;&#x2F; </span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        obj: &#123;</span><br><span class="line">            a:1 &#x2F;&#x2F; 响应式属性</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">    addObj() &#123;</span><br><span class="line">        this.obj.b &#x3D; 2 &#x2F;&#x2F; 非响应式属性</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>上面的代码希望调用addObj方法向<code>this.obj</code>添加属性并且视图能够更新。失败！需要向响应式对象添加属性应该用Vue.set()方法才能将添加的属性变为响应式的。<br>对于已经创建的实例，Vue不允许动态添加根级别的响应式属性。但是，Vue提供了<code>Vue.set(obj, propertyName, value)</code>方法向嵌套对象添加响应式属性。列如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.$set(this.obj, &#39;b&#39;, 2)</span><br></pre></td></tr></table></figure>
<p>需要为已有对象赋值多个新属性时应该用原对象与要混合进去的对象的新属性一起创建一个新对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.obj &#x3D; Object.assign(&#123;&#125;, this.obj, &#123;c: 3, d: 4&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="异步更新队列"><a href="#异步更新队列" class="headerlink" title="异步更新队列"></a>异步更新队列</h3><p>Vue在更新DOM时是<strong>异步</strong>执行的。只要侦听到数据的变化，Vue将开启一个队列，并缓冲 在同一事件循环中发生的所有数据变更。如果同一个watcher被多次触发，只会被推入到队列中一次。这种在缓冲时去除重复数据对于避免不必要的计算和DOM操作非常重要。然后，在下一个事件循环tick中，Vue刷新队列并执行实际工作。Vue在内部对异步队列尝试使用原生的<code>Promise.then</code>、<code>MutationObserver</code>和<code>setTimeOut</code>，如果执行环境不支持，则会采用<code>setTimeOut(fn, 0)</code>代替。<br>为了在数据变化之后等待Vue完成更新DOM，可以在数据变化后立即使用<code>Vue.nextTick(callback)</code>。这样回调函数将在DOM更新完后被调用。<br><code>nextTick()</code>返回一个<code>Promise</code>对象，所以可以使用<code>async/await</code>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">async function () &#123;</span><br><span class="line">    &lt;!-- DOM未更新 --&gt;</span><br><span class="line">    await this.$nextTick()</span><br><span class="line">    &lt;!-- DOM已更新 --&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a href="/zoey.github.io/2019/07/11/node%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD/" class="prev">PREV</a><a href="/zoey.github.io/2019/07/06/Vuex%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://yoursite.com">John Doe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>